<app-title-section [title]="title"></app-title-section>

<div>
    <section>
        <!-- <div class="row m-1">
            <div class="col-md-3">
                <select class="form-control form-control-sm" name="filter" id="filter" [(ngModel)]="attr_selected">
                    <option *ngFor="let attr of attr_list" [ngValue]="attr">
                        {{ attr }}
                    </option>
                </select>
            </div>
            <div class="col-md-3">
                <div class="form-check">
                    <input  class="form-control form-control-sm round" type="text" id="search" placeholder="Buscar.." [(ngModel)]="searchText">
                </div>
            </div>
            <div class="col-md-3">
                <button class="btn btn-sm btn-outline-secondary" (click)="applyFilter()">Aplicar filtro</button>
            </div>
        </div> -->
        <div class="row">
            <div class="table-responsive text-center">
                <table class="table table-sm table-hover">
                    <thead class="thead-dark">
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col" width="11%">Fecha/Hora</th>
                            <th scope="col">Cliente</th>
                            <th scope="col">Estado</th>
                            <th scope="col">Total</th>
                            <th scope="col">Cond. Venta</th>
                            <th scope="col">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let movement of movements">
                            <td> {{ movement.id }} </td>
                            <td> {{ movement.fecha_hora | date:'medium' }} </td>
                            <td> {{ movement.cliente.nombre + ' ' + movement.cliente.apellido }} </td>
                            <td> {{
                                (movement.estado === 'p'
                                ? "Pendiente"
                                : movement.estado === 'c'
                                ? "Completado"
                                : "Anulado") | uppercase
                                }} </td>
                            <td> {{ movement.total | currency:'ARS':'symbol':'1.0' }} </td>
                            <td> {{ movement.modo_pago | uppercase }} </td>
                            <td>
                                <button class="btn btn-primary btn-sm btn-acciones" data-toggle="modal"
                                    data-target="#seeMovement" (click)="setSelectedMovement(movement)">
                                    Ver
                                </button>

                                <button *ngIf="movement.estado === 'c' || movement.estado === 'p'"
                                    class="btn btn-danger btn-sm btn-acciones" (click)="changeState(movement.id, 'a')">
                                    Anular
                                </button>

                                <button *ngIf="movement.estado === 'a' || movement.estado === 'p'"
                                    class="btn btn-success btn-sm btn-acciones" (click)="changeState(movement.id, 'c')">
                                    Completo
                                </button>

                                <button *ngIf="movement.estado === 'a' || movement.estado === 'c'"
                                    class="btn btn-warning btn-sm btn-acciones" (click)="changeState(movement.id, 'p')">
                                    Pendiente
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <app-paginacion (changePage)="pageChanged($event)"></app-paginacion>


</div>


<div class="modal fade bd-example-modal-lg" id="seeMovement" tabindex="-1" role="dialog" aria-labelledby="seeMovement"
    aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content p-4 text-center">

            <div class="row">
                <div class="mt-3 col-md-12 col-sm-12 col-lg-12 shadow card">
                    <div class="row">
                        <div class="col-sm-12 col-md-4 col-lg-4">
                            <b> # </b> {{ movementSelected.id }}
                        </div>
                        <div class="col-sm-12 col-md-4 col-lg-4">
                            <b> Fecha/Hora: </b> {{ movementSelected.fecha_hora | date:'medium' }}
                        </div>
                        <div class="col-sm-12 col-md-4 col-lg-4">
                            <b> Cliente: </b> {{ movementSelected?.cliente?.nombre }}
                            {{ movementSelected?.cliente?.apellido }}
                        </div>
                    </div>

                </div>
                <div class="mt-3 col-md-12 col-sm-12 col-lg-12 shadow card">
                    <div class="row">
                        <div class="col-sm-12 col-md-4 col-lg-4">
                            <b> Estado: </b>
                            {{
                            (movementSelected.estado === 'p'
                            ? "Pendiente"
                            : movementSelected.estado === 'c'
                            ? "Completado"
                            : "Anulado") | uppercase
                            }}
                        </div>
                        <div class="col-sm-12 col-md-4 col-lg-4">
                            <b> Total: </b> {{ movementSelected.total | currency:'ARS':'symbol':'1.0' }}
                        </div>
                        <div class="col-sm-12 col-md-4 col-lg-4">
                            <b> Saldo: </b> {{ movementSelected.saldo | currency:'ARS':'symbol':'1.0' }}
                        </div>
                    </div>
                </div>
                <div class="mt-3 col-md-6 col-sm-6 col-lg-6 shadow card">
                    <b> Modo de pago:</b> {{ movementSelected.modo_pago | uppercase }}
                </div>
                <div *ngIf="movementSelected.comentario !== ''" class="mt-3 col-md-12 col-sm-12 col-lg-12 shadow card">
                    <b> Descripción: </b> {{ movementSelected.comentario | uppercase }}
                </div>
                <div class="mt-3 col-md-12 col-sm-12 col-lg-12 shadow card">
                    <b> Artículos: </b>
                    <div class="table-responsive text-center">
                        <table class="table table-sm table-hover">
                            <thead class="thead-dark">
                                <th># </th>
                                <th> Título </th>
                                <th> Precio venta </th>
                                <!-- <th> Precio oferta </th> -->
                            </thead>
                            <tbody>
                                <tr *ngFor="let art of movementSelected.movimiento_lineas">
                                    <td>{{ art.id_producto }} </td>
                                    <td>{{ art.nombre }} </td>
                                    <td>{{ art.precio_venta | currency:'ARS':'symbol':'2.0' }} </td>
                                    <!-- <td>{{ art.precio_oferta | currency:'ARS':'symbol':'2.0' }} </td> -->
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div *ngIf="movementSelected.modo_pago === 'ctacte' || movementSelected.modo_pago === 'tarjeta'"
                    class="mt-3 col-md-12 col-sm-12 col-lg-12 shadow card">
                    <b> Pagos: </b>
                    <div class="table-responsive text-center">
                        <table class="table table-sm table-hover">
                            <thead class="thead-dark">
                                <th># </th>
                                <th>Monto </th>
                                <th>Fecha </th>
                                <!-- <th>Recargo </th> -->
                                <th>Interés </th>
                                <th>Ganancia</th>
                                <th>Acciones</th>
                            </thead>
                            <tbody>
                                <tr *ngFor="let pago of movementSelected.pagos">
                                    <td>{{ pago?.pago_nro }} </td>
                                    <td>
                                        {{ pago?.monto | currency:'ARS':'symbol':'1.0' }}
                                    </td>
                                    <td>{{ pago?.fecha_hora | date:'medium' }} </td>
                                    <!-- <td>{{ pago?.monto_recargo | currency:'ARS':'symbol':'1.0' }} </td> -->
                                    <td>{{ pago?.tasa_interes + '%' }} </td>
                                    <td>{{ pago?.ganancia | currency:'ARS':'symbol':'1.0' }} </td>
                                    <td>
                                        <button class="btn btn-sm btn-primary">
                                            Editar
                                        </button>
                                        <button class="btn btn-sm btn-danger" (click)="deletePayment(pago)">
                                            Eliminar
                                        </button>
                                    </td>

                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div *ngIf="movementSelected.modo_pago === 'ctacte' || movementSelected.modo_pago === 'tarjeta'"
                    class="mt-3 col-md-12 col-sm-12 col-lg-12 shadow card">

                    <button class="btn btn-primary btn-sm float-right m-2" type="button" data-toggle="collapse"
                        data-target="#newPay" aria-expanded="false" aria-controls="newPay">
                        Añadir pago
                    </button>

                    <div class="collapse" id="newPay">
                        <!-- <div class="shadow"> -->
                        <form [formGroup]="paymentForm" (ngSubmit)="isValidPayment()">
                            <div class="row">
                                <div class="col-sm-4 col-md-4 col-lg-4">
                                    <label for="monto">Monto</label>
                                    <input id="monto" class="form-control form-control-sm" type="number"
                                        placeholder="Monto" formControlName="monto" (change)="calculateProfit()"
                                        (keyup)="calculateProfit()" />
                                </div>
                                <div class="col-sm-4 col-md-4 col-lg-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="" id="interes"
                                            [ngModelOptions]="{standalone: true}" formControlName="interes" (change)="calculateProfit()">
                                        <label class="form-check-label" for="interes">
                                            Interés
                                        </label>
                                        <input *ngIf="paymentForm.controls['interes'].value" id="tasa_interes"
                                            class="form-control form-control-sm mt-2" type="number" placeholder="$"
                                            formControlName="tasa_interes" (change)="calculateProfit()"
                                            (keyup)="calculateProfit()" />
                                    </div>
                                </div>
                                <div class="col-sm-4 col-md-4 col-lg-4">
                                    <label for="fecha_hora">Fecha</label>
                                    <input id="fecha_hora" class="form-control form-control-sm" type="date"
                                        formControlName="fecha_hora" />
                                </div>
                                <div class="col-sm-6 col-md-6 col-lg-6 mt-3">
                                    <label for="ganancia">Total a pagar:</label>
                                    <p> {{ paymentForm.controls['monto'].value + paymentForm.controls['ganancia'].value | currency:'ARS':'symbol':'1.0' }}</p>
                                </div>

                                <div class="col-sm-6 col-md-6 col-lg-6 mt-3">
                                    <label for="ganancia">Ganancia obtenida</label>
                                    <p> {{ paymentForm.controls['ganancia'].value | currency:'ARS':'symbol':'1.0' }}
                                    </p>
                                    <input [hidden]="true" id="ganancia" class="form-control form-control-sm"
                                        type="number" placeholder="Ganancia" formControlName="ganancia" />
                                </div>


                                <div class="col-sm-12 col-md-12 col-lg-12 mt-5">
                                    <button class="btn btn-sm btn-outline-danger float-right ml-2"
                                        [disabled]="paymentForm.invalid" type="submit">
                                        Guardar
                                    </button>
                                </div>

                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<router-outlet></router-outlet>